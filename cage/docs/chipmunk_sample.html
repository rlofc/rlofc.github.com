

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>samples / chipmunk.c &mdash; Cage  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/breathe.css" type="text/css" />
  

  
    <link rel="top" title="Cage  documentation" href="index.html"/>
        <link rel="next" title="samples / wizard.c" href="wizard.html"/>
        <link rel="prev" title="samples / collisions.c" href="collisions_sample.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Cage
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="game.html">Game essentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="image.html">image</a></li>
<li class="toctree-l1"><a class="reference internal" href="font.html">font</a></li>
<li class="toctree-l1"><a class="reference internal" href="sprite.html">sprite</a></li>
<li class="toctree-l1"><a class="reference internal" href="animate.html">animation</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeline.html">timeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="sound.html">sound</a></li>
<li class="toctree-l1"><a class="reference internal" href="keyboard.html">keyboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="mouse.html">mouse</a></li>
<li class="toctree-l1"><a class="reference internal" href="screen.html">screen</a></li>
<li class="toctree-l1"><a class="reference internal" href="color.html">color</a></li>
<li class="toctree-l1"><a class="reference internal" href="state_sample.html">samples / state.c</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_sample.html">samples / image.c</a></li>
<li class="toctree-l1"><a class="reference internal" href="sprite_sample.html">samples / sprite.c</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeline_sample.html">samples / timeline.c</a></li>
<li class="toctree-l1"><a class="reference internal" href="callout_sample.html">samples / callout.c</a></li>
<li class="toctree-l1"><a class="reference internal" href="collisions_sample.html">samples / collisions.c</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">samples / chipmunk.c</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sample-setup">Sample setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparing-the-tiles">Preparing the tiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparing-the-walls">Preparing the walls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updating-each-frame">Updating each frame</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cleanup">Cleanup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#main">Main</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="wizard.html">samples / wizard.c</a></li>
<li class="toctree-l1"><a class="reference internal" href="tiled.html">samples / tiled.c</a></li>
<li class="toctree-l1"><a class="reference internal" href="android.html">CAGE on Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">(More) Advanced</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Cage</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>samples / chipmunk.c</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="samples-chipmunk-c">
<h1>samples / chipmunk.c<a class="headerlink" href="#samples-chipmunk-c" title="Permalink to this headline">¶</a></h1>
<p>This sample demonstrates how to integrate Chipmunk2D with
CAGE. We will draw a set of dynamic tiles on the screen,
allowing the user to select and push any tile using the
mouse and generate 2D collisions.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &quot;cage.h&quot;</span>
<span class="cp">#include &quot;chipmunk.h&quot;</span>
</pre></div>
</div>
<div class="section" id="sample-setup">
<h2>Sample setup<a class="headerlink" href="#sample-setup" title="Permalink to this headline">¶</a></h2>
<p>For this demo we will use a makeshift tilemap and turn each
tile into a Chipmunk2D body.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">tile_map</span><span class="p">[]</span> <span class="o">=</span>
    <span class="s">&quot;############  ############  ############  ############&quot;</span>
    <span class="s">&quot;############  ############  ############  ############&quot;</span>
    <span class="s">&quot;############  ############  ############  ############&quot;</span>
    <span class="s">&quot;############  ############  ############  ############&quot;</span>
    <span class="s">&quot;####          ####    ####  ####          ####        &quot;</span>
    <span class="s">&quot;####          ####    ####  ####          ####        &quot;</span>
    <span class="s">&quot;####          ####    ####  ####  ######  ############&quot;</span>
    <span class="s">&quot;####          ############  ####  ######  ############&quot;</span>
    <span class="s">&quot;####          ############  ####  ######  ############&quot;</span>
    <span class="s">&quot;####          ############  ####  ######  ############&quot;</span>
    <span class="s">&quot;####          ############  ####     ###  ####        &quot;</span>
    <span class="s">&quot;####          ####    ####  ####     ###  ####        &quot;</span>
    <span class="s">&quot;############  ####    ####  ############  ############&quot;</span>
    <span class="s">&quot;############  ####    ####  ############  ############&quot;</span>
    <span class="s">&quot;############  ####    ####  ############  ############&quot;</span>
    <span class="s">&quot;############  ####    ####  ############  ############&quot;</span><span class="p">;</span>
<span class="cp">#define MAX_TILES (sizeof tile_map / sizeof tile_map[0])</span>
</pre></div>
</div>
<p>Each tile will hold an a Chipmunk2D body and shape that
we&#8217;ll need to create individually.
We will also use is_active to indicate the the tile
is one of the # tiles that we need to simulate and draw.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">tile</span> <span class="p">{</span>
    <span class="n">cpBody</span><span class="o">*</span> <span class="n">body</span><span class="p">;</span>
    <span class="n">cpShape</span><span class="o">*</span> <span class="n">shape</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">is_active</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The game state is the top-level data-structure in this sample.
It holds the tiles array, the tile image and the basic
Chipmunk2D entities we&#8217;ll use, primarily the space entity.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define N_WALLS 4</span>
<span class="k">struct</span> <span class="n">state</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">tile</span> <span class="n">tiles</span><span class="p">[</span><span class="n">MAX_TILES</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">image</span><span class="o">*</span> <span class="n">tile_img</span><span class="p">;</span>
    <span class="n">cpSpace</span><span class="o">*</span> <span class="n">space</span><span class="p">;</span>
    <span class="n">cpBody</span><span class="o">*</span> <span class="n">mouse_body</span><span class="p">;</span>
    <span class="n">cpConstraint</span><span class="o">*</span> <span class="n">mouse_joint</span><span class="p">;</span>
    <span class="n">cpShape</span><span class="o">*</span> <span class="n">walls</span><span class="p">[</span><span class="n">N_WALLS</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define GRABBABLE_MASK_BIT (1 &lt;&lt; 31)</span>
<span class="n">cpShapeFilter</span> <span class="n">GRAB_FILTER</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CP_NO_GROUP</span><span class="p">,</span> <span class="n">GRABBABLE_MASK_BIT</span><span class="p">,</span>
                              <span class="n">GRABBABLE_MASK_BIT</span> <span class="p">};</span>
<span class="n">cpShapeFilter</span> <span class="n">NOT_GRABBABLE_FILTER</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CP_NO_GROUP</span><span class="p">,</span> <span class="o">~</span><span class="n">GRABBABLE_MASK_BIT</span><span class="p">,</span>
                                       <span class="o">~</span><span class="n">GRABBABLE_MASK_BIT</span> <span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="preparing-the-tiles">
<h2>Preparing the tiles<a class="headerlink" href="#preparing-the-tiles" title="Permalink to this headline">¶</a></h2>
<p>We traverse the tilemap string, detecting any &#8220;lit&#8221; tile
using the character #. For each &#8220;lit&#8221; tile, we create a
Chipmunk2D body and position it in screen coordinates.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">init_tiles</span><span class="p">(</span><span class="k">struct</span> <span class="n">state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">cpFloat</span> <span class="n">radius</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tile_img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">cpFloat</span> <span class="n">mass</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">cpFloat</span> <span class="n">moment</span> <span class="o">=</span> <span class="n">cpMomentForCircle</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">cpvzero</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tile_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tile_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">body</span> <span class="o">=</span>
                <span class="n">cpSpaceAddBody</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="n">cpBodyNew</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">moment</span><span class="p">));</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shape</span> <span class="o">=</span> <span class="n">cpSpaceAddShape</span><span class="p">(</span>
                <span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span>
                <span class="n">cpCircleShapeNew</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">body</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">cpvzero</span><span class="p">));</span>
            <span class="n">cpShapeSetFriction</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">);</span>
            <span class="n">cpVect</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">cpv</span><span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">54</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">54</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">40</span><span class="p">);</span>
            <span class="n">cpBodySetPosition</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">body</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A matching cleanup_tiles function to make sure
we free the chipmunk resources we allocated during
init_tiles(). Remember - Chipmunk2D is not doing any
garbage collection and any time we call one of the New
functions we need to match it with a corresponding Free
call when we&#8217;re done.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_tiles</span><span class="p">(</span><span class="k">struct</span> <span class="n">state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TILES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cpShapeFree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shape</span><span class="p">);</span>
            <span class="n">cpBodyFree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">body</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="preparing-the-walls">
<h2>Preparing the walls<a class="headerlink" href="#preparing-the-walls" title="Permalink to this headline">¶</a></h2>
<p>We use 4 lines as walls at the extreme ends of the screen.
Each line becomes a Chipmunk2D static_body.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">init_walls</span><span class="p">(</span><span class="k">struct</span> <span class="n">state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
    <span class="n">get_screen_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
    <span class="n">cpBody</span><span class="o">*</span> <span class="n">static_body</span> <span class="o">=</span> <span class="n">cpSpaceGetStaticBody</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">);</span>
    <span class="n">cpVect</span> <span class="n">walls</span><span class="p">[</span><span class="n">N_WALLS</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{{</span><span class="n">cpv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">cpv</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)},</span>
                                <span class="p">{</span><span class="n">cpv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cpv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">)},</span>
                                <span class="p">{</span><span class="n">cpv</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cpv</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)},</span>
                                <span class="p">{</span><span class="n">cpv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cpv</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}};</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">N_WALLS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">walls</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
            <span class="n">cpSegmentShapeNew</span><span class="p">(</span><span class="n">static_body</span><span class="p">,</span> <span class="n">walls</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">walls</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">cpShapeSetFriction</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">walls</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">cpSpaceAddShape</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">walls</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We also need to cleanup the walls we created.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_walls</span><span class="p">(</span><span class="k">struct</span> <span class="n">state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">N_WALLS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cpShapeFree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">walls</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>create_sample is our game state&#8217;s initialization function
and will return a fully ready instance of struct state for us
to work with in each frame.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">create_sample</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">state</span><span class="p">));</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="n">cpSpaceNew</span><span class="p">();</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">tile_img</span> <span class="o">=</span> <span class="n">create_image</span><span class="p">(</span><span class="s">&quot;res/particle.png&quot;</span><span class="p">);</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_body</span> <span class="o">=</span> <span class="n">cpBodyNewKinematic</span><span class="p">();</span>
    <span class="n">init_tiles</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="n">init_walls</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Mouse handling is a bit tricky. We want the user to move
tiles using the mouse but because tiles are dynamic bodies
managed by Chipmunk2D, we cannot directly control them.
This is resolved by creating a pivot joint between an
invisible mouse body that we can control and the tile body
that we cannot directly control.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">apply_mouse_motion</span><span class="p">(</span><span class="k">struct</span> <span class="n">state</span><span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">mouse</span> <span class="n">m</span><span class="p">;</span>
    <span class="n">update_mouse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
    <span class="n">get_screen_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">x_position</span> <span class="o">*</span> <span class="n">w</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">y_position</span> <span class="o">*</span> <span class="n">h</span><span class="p">;</span>
    <span class="n">cpVect</span> <span class="n">mouse_pos</span> <span class="o">=</span> <span class="n">cpv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="n">cpVect</span> <span class="n">new_point</span> <span class="o">=</span>
        <span class="n">cpvlerp</span><span class="p">(</span><span class="n">cpBodyGetPosition</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_body</span><span class="p">),</span> <span class="n">mouse_pos</span><span class="p">,</span> <span class="mf">0.25f</span><span class="p">);</span>
    <span class="n">cpBodySetVelocity</span><span class="p">(</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_body</span><span class="p">,</span>
        <span class="n">cpvmult</span><span class="p">(</span><span class="n">cpvsub</span><span class="p">(</span><span class="n">new_point</span><span class="p">,</span> <span class="n">cpBodyGetPosition</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_body</span><span class="p">)),</span>
                <span class="mf">60.0f</span><span class="p">));</span>
    <span class="n">cpBodySetPosition</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_body</span><span class="p">,</span> <span class="n">new_point</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">left_click</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cpFloat</span> <span class="n">radius</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">;</span>
        <span class="n">cpPointQueryInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="n">cpShape</span><span class="o">*</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">cpSpacePointQueryNearest</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="n">mouse_pos</span><span class="p">,</span>
                                                  <span class="n">radius</span><span class="p">,</span> <span class="n">GRAB_FILTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shape</span> <span class="o">&amp;&amp;</span> <span class="n">cpBodyGetMass</span><span class="p">(</span><span class="n">cpShapeGetBody</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">INFINITY</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cpVect</span> <span class="n">nearest</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="mf">0.0f</span> <span class="o">?</span> <span class="n">info</span><span class="p">.</span><span class="nl">point</span> <span class="p">:</span> <span class="n">mouse_pos</span><span class="p">);</span>
            <span class="n">cpBody</span><span class="o">*</span> <span class="n">body</span> <span class="o">=</span> <span class="n">cpShapeGetBody</span><span class="p">(</span><span class="n">shape</span><span class="p">);</span>
            <span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span> <span class="o">=</span>
                <span class="n">cpPivotJointNew2</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_body</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">cpvzero</span><span class="p">,</span>
                                 <span class="n">cpBodyWorldToLocal</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">nearest</span><span class="p">));</span>
            <span class="n">cpConstraintSetMaxForce</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span><span class="p">,</span> <span class="mf">5000000.0f</span><span class="p">);</span>
            <span class="n">cpConstraintSetErrorBias</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span><span class="p">,</span>
                                     <span class="n">cpfpow</span><span class="p">(</span><span class="mf">1.0f</span> <span class="o">-</span> <span class="mf">0.15f</span><span class="p">,</span> <span class="mf">60.0f</span><span class="p">));</span>
            <span class="n">cpSpaceAddConstraint</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">left_click</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cpSpaceRemoveConstraint</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span><span class="p">);</span>
        <span class="n">cpConstraintFree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span><span class="p">);</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_joint</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-each-frame">
<h2>Updating each frame<a class="headerlink" href="#updating-each-frame" title="Permalink to this headline">¶</a></h2>
<p>Updating and drawing a frame takes stepping the Chipmunk2D
simulation by the 1/1000s fration of a second passed and
then drawing any active tile using its up-to-date
position.
We then delegate any mouse actions to apply_mouse_motion().</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">update_sample</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">float</span> <span class="n">elapsed_ms</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">cpFloat</span> <span class="n">timeStep</span> <span class="o">=</span> <span class="n">elapsed_ms</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span>
    <span class="n">cpSpaceStep</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">);</span>
    <span class="n">screen_color</span><span class="p">(</span><span class="n">color_from_RGB</span><span class="p">(</span><span class="mi">244</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">244</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TILES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cpVect</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">cpBodyGetPosition</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">body</span><span class="p">);</span>
            <span class="n">draw_image</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tile_img</span><span class="p">,</span> <span class="n">pos</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tile_img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tile_img</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">apply_mouse_motion</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="cleanup">
<h2>Cleanup<a class="headerlink" href="#cleanup" title="Permalink to this headline">¶</a></h2>
<p>Clean up is simple enough. Just destroy the tile
image and free the state structure memory.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_sample</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">cleanup_walls</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="n">cleanup_tiles</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="n">destroy_image</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tile_img</span><span class="p">);</span>
    <span class="n">cpBodyFree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mouse_body</span><span class="p">);</span>
    <span class="n">cpSpaceFree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="main">
<h2>Main<a class="headerlink" href="#main" title="Permalink to this headline">¶</a></h2>
<p>The usual game_loop call, using the usual state
functions.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">game_loop</span><span class="p">(</span><span class="n">create_sample</span><span class="p">,</span> <span class="n">update_sample</span><span class="p">,</span> <span class="n">destroy_sample</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="wizard.html" class="btn btn-neutral float-right" title="samples / wizard.c" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="collisions_sample.html" class="btn btn-neutral" title="samples / collisions.c" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2016, Ithai Levi (RLofC@).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>